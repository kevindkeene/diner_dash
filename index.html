<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Catch-22: 4K Ultra Landscape</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&family=Black+Ops+One&family=Titan+One&family=Bungee&family=Orbitron:wght@400;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: #f9fafb; 
            margin: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden; 
            user-select: none;
            touch-action: none;
        }

        /* 16:9 Landscape Container Logic */
        #game-container {
            position: relative;
            /* Lock to 16:9 aspect ratio based on available screen size */
            width: min(100vw, calc(100vh * (16 / 9)));
            height: min(100vh, calc(100vw * (9 / 16)));
            display: flex;
            flex-direction: column;
            background: #000;
            box-shadow: 0 0 100px rgba(0,0,0,1);
            overflow: hidden;
        }

        #game-area {
            position: relative;
            width: 100%;
            flex-grow: 1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden;
            touch-action: none; 
        }

        /* UI Scaling for 4K */
        .hud-text { font-size: min(2.5vw, 32px); }
        .hud-sub { font-size: min(1vw, 14px); }

        .mad-bomber-img {
            position: absolute;
            top: 2%;
            z-index: 100;
            transform: translateX(-50%);
        }

        .bucket-stack {
            position: absolute;
            display: flex; 
            flex-direction: column-reverse; 
            align-items: center; 
            justify-content: flex-start;
            z-index: 90;
            transform: translateX(-50%);
            bottom: 5%;
        }

        .bucket-img { object-fit: contain; width: 100%; height: 100%; }
        .bomb-img { position: absolute; z-index: 50; transform: translateX(-50%); }

        #gunk-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #22c55e;
            pointer-events: none;
            z-index: 150;
            opacity: 0;
            transition: opacity 0.1s linear;
        }
        
        .explosion-img { 
            position: absolute; 
            z-index: 200; 
            pointer-events: none; 
            transform: translate(-50%, -50%); 
            animation: explode 0.5s ease-out forwards; 
        }

        @keyframes explode {
            0% { transform: translate(-50%, -50%) scale(0.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }

        .game-status-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            z-index: 300;
        }

        .pixel-art { image-rendering: pixelated; }
        .font-brand { font-family: 'Bungee', cursive; }
        .font-neon { font-family: 'Orbitron', sans-serif; }

        .btn-4k {
            padding: 1.5rem 3rem;
            border-radius: 1rem;
            font-size: 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            transition: transform 0.1s, background 0.2s;
            border: 4px solid rgba(255,255,255,0.1);
            cursor: pointer;
            pointer-events: auto;
        }
        .btn-4k:active { transform: scale(0.95); }

        .playing #game-area { cursor: none; }

        #fullscreen-toggle {
            transition: all 0.2s;
        }
        #fullscreen-toggle:hover {
            background-color: rgba(30, 41, 59, 1);
            color: white;
        }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const INITIAL_BUCKET_COUNT = 3;
        const CATCHES_PER_LEVEL = 15;

        const THEMES = {
            'classic': {
                title: 'Short Fuse', id: 'classic', isStacked: true, fontClass: 'font-short-fuse', color: '#ef4444',
                bomberDim: { w: 8, h: 12 }, bombDim: { w: 4, h: 8 },
                bucketDim: { w: 8, h: 6, gap: 1.5 },
                hitbox: { catchW: 8 }, 
                graphics: {
                    BOMBER: 'https://kevindkeene.github.io/diner_dash/assets/bomber336x800.gif',
                    BOMB: 'https://kevindkeene.github.io/diner_dash/assets/bomb240x448.gif',
                    BUCKET: 'https://kevindkeene.github.io/diner_dash/assets/bucket.gif', 
                    BACKGROUND: 'https://kevindkeene.github.io/diner_dash/assets/kaboom-background.gif',
                    SLIME: 'https://kevindkeene.github.io/diner_dash/assets/slimeball.gif'
                },
                settings: { baseBombSpeed: 1.2, initialBomberSpeed: 1.0, twitchChance: 0.04 }
            },
            'alien-drop': {
                title: 'Bale Out', id: 'alien-drop', isStacked: false, fontClass: 'font-bale-out', color: '#84cc16',
                bomberDim: { w: 10, h: 16 }, bombDim: { w: 5, h: 10 }, 
                bucketDim: { w: 15, h: 18, gap: 0 },
                hitboxByLife: [{ catchW: 12 }, { catchW: 12 }, { catchW: 12 }],
                graphics: {
                    BOMBER: 'https://kevindkeene.github.io/diner_dash/assets/ufo2-400x400.gif', 
                    BOMB: 'https://kevindkeene.github.io/diner_dash/assets/cow3.gif', 
                    SLIME: 'https://kevindkeene.github.io/diner_dash/assets/slimeball.gif',
                    BUCKET_LAYERS: [
                        'https://kevindkeene.github.io/diner_dash/assets/tractor-0hay.gif',
                        'https://kevindkeene.github.io/diner_dash/assets/tractor-1hay.gif',
                        'https://kevindkeene.github.io/diner_dash/assets/tractor-2hay.gif',
                        'https://kevindkeene.github.io/diner_dash/assets/tractor-3hay.gif'
                    ],
                    BACKGROUND: 'https://kevindkeene.github.io/diner_dash/assets/alien_background2.gif'
                },
                settings: { baseBombSpeed: 1.4, initialBomberSpeed: 1.2, twitchChance: 0.06 }
            }
        };

        // --- FIREBASE CONFIG HANDLING ---
        const githubFirebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : githubFirebaseConfig;
        } catch (e) {
            firebaseConfig = githubFirebaseConfig;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'catch-22-v2';
        let db, auth, userId = null;

        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    fetchLeaderboards();
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) { console.error("Auth error", err); }
                }
            });
        }

        // --- STATE ---
        let score = 0, lives = INITIAL_BUCKET_COUNT, level = 1;
        let isGameOver = true, isGamePaused = false, frame = 0;
        let bombs = [], currentThemeId = 'classic';
        let bucketX = 50, madBomberX = 50, madBomberDirection = 1, speedMultiplier = 1;
        let catchesThisLevel = 0, gunkTimeRemaining = 0;
        let animationFrameHandle;
        let leaderboards = {};

        async function fetchLeaderboards() {
            if (!db) return;
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
            onSnapshot(q, (snapshot) => {
                const data = {};
                snapshot.forEach(doc => {
                    const s = doc.data();
                    if (!data[s.theme] || s.score > data[s.theme].score) data[s.theme] = s;
                });
                leaderboards = data;
                if (isGameOver) showMenu();
            }, (err) => console.error("Firestore error", err));
        }

        async function saveScore() {
            if (!db || !userId || score === 0) return;
            const scoreDoc = doc(db, 'artifacts', appId, 'public', 'data', 'scores', userId + "_" + currentThemeId);
            await setDoc(scoreDoc, { userId, score, theme: currentThemeId, timestamp: Date.now() });
        }

        function triggerHaptic(pattern) { if ("vibrate" in navigator) { navigator.vibrate(pattern); } }

        function startGame(themeId) {
            isGameOver = false; isGamePaused = false;
            currentThemeId = themeId;
            document.body.classList.add('playing');
            score = 0; lives = INITIAL_BUCKET_COUNT; frame = 0; level = 1;
            speedMultiplier = 1; catchesThisLevel = 0;
            madBomberX = 50;
            gunkTimeRemaining = 0;
            bombs.forEach(b => b.el.remove()); bombs = [];
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('gunk-overlay').style.opacity = 0;
            initGameElements();
            updateStats();
            gameLoop();
        }

        function initGameElements() {
            const theme = THEMES[currentThemeId];
            const area = document.getElementById('game-area');
            area.style.backgroundImage = `url('${theme.graphics.BACKGROUND}')`;
            document.getElementById('buckets-stack').style.width = `${theme.bucketDim.w}%`;
            document.getElementById('mad-bomber-img').style.width = `${theme.bomberDim.w}%`;
            updateBucketVisuals();
            document.getElementById('mad-bomber-img').innerHTML = `<img src="${theme.graphics.BOMBER}" class="pixel-art w-full h-full">`;
            document.getElementById('life-icon').src = theme.isStacked ? theme.graphics.BUCKET : theme.graphics.BUCKET_LAYERS[1];
        }

        function updateBucketVisuals() {
            const theme = THEMES[currentThemeId];
            const stack = document.getElementById('buckets-stack');
            stack.innerHTML = '';
            if (theme.isStacked) {
                for (let i = 0; i < lives; i++) {
                    const b = document.createElement('img');
                    b.src = theme.graphics.BUCKET; b.className = 'bucket-img pixel-art';
                    b.style.height = `${theme.bucketDim.h}%`; 
                    b.style.marginTop = `-${theme.bucketDim.gap}%`;
                    stack.appendChild(b);
                }
            } else {
                const b = document.createElement('img');
                b.id = 'single-catcher-img'; b.className = 'bucket-img pixel-art';
                b.src = theme.graphics.BUCKET_LAYERS[lives] || theme.graphics.BUCKET_LAYERS[0];
                b.style.height = `${theme.bucketDim.h}%`;
                stack.appendChild(b);
            }
        }

        function gameLoop() {
            if (isGameOver || isGamePaused) return;
            frame++;
            if (gunkTimeRemaining > 0) {
                gunkTimeRemaining -= 16;
                document.getElementById('gunk-overlay').style.opacity = (gunkTimeRemaining / 3000) * 0.4;
            }
            updateBomber();
            updateBombs();
            animationFrameHandle = requestAnimationFrame(gameLoop);
        }

        function updateBomber() {
            const theme = THEMES[currentThemeId];
            const base = theme.settings.initialBomberSpeed * speedMultiplier;
            if (Math.random() < theme.settings.twitchChance) madBomberDirection *= -1;
            madBomberX += madBomberDirection * base;
            if (madBomberX > 94) madBomberDirection = -1;
            else if (madBomberX < 6) madBomberDirection = 1;
            document.getElementById('mad-bomber-img').style.left = `${madBomberX}%`;
            
            const dropRate = Math.max(20, 80 - (level * 4));
            if (frame % Math.floor(dropRate) === 0) {
                createBomb(madBomberX, 10, Math.random() < 0.1 ? 'slime' : 'good');
            }
        }

        function createBomb(x, y, type) {
            const theme = THEMES[currentThemeId];
            const el = document.createElement('div');
            el.className = 'bomb-img pixel-art absolute';
            el.style.width = `${theme.bombDim.w}%`; 
            el.style.left = `${x}%`; 
            el.style.top = `${y}%`;
            el.innerHTML = `<img src="${type === 'slime' ? theme.graphics.SLIME : theme.graphics.BOMB}" class="w-full h-full">`;
            document.getElementById('game-area').appendChild(el);
            bombs.push({ x, y, el, type, speed: theme.settings.baseBombSpeed * speedMultiplier });
        }

        function updateBombs() {
            const theme = THEMES[currentThemeId];
            const hitboxW = theme.isStacked ? theme.hitbox.catchW : theme.hitboxByLife[Math.max(0, lives-1)].catchW;
            for (let i = bombs.length - 1; i >= 0; i--) {
                const b = bombs[i];
                b.y += b.speed;
                b.el.style.top = `${b.y}%`;
                if (b.y > 78 && b.y < 86) {
                    if (Math.abs(b.x - bucketX) < hitboxW / 1.5) handleCatch(i, b);
                } else if (b.y > 95) {
                    if (b.type === 'good') handleMiss(i, b);
                    else { b.el.remove(); bombs.splice(i, 1); }
                }
            }
        }

        function handleCatch(idx, b) {
            if (b.type === 'slime') {
                gunkTimeRemaining = 3000;
                triggerHaptic(100);
            } else {
                score += (level * 10); catchesThisLevel++; triggerHaptic(20);
                if (catchesThisLevel >= CATCHES_PER_LEVEL) nextLevel();
            }
            b.el.remove(); bombs.splice(idx, 1);
            updateStats();
        }

        function handleMiss(idx, b) {
            isGamePaused = true;
            createExplosion(b.x, 90);
            b.el.remove(); bombs.splice(idx, 1);
            lives--;
            updateBucketVisuals();
            updateStats();
            if (lives <= 0) endGame();
            else setTimeout(() => { isGamePaused = false; gameLoop(); }, 1000);
        }

        function createExplosion(x, y) {
            const ex = document.createElement('div');
            ex.className = 'explosion-img pixel-art';
            ex.style.left = `${x}%`; ex.style.top = `${y}%`; ex.style.width = '15%';
            ex.innerHTML = `<img src="https://kevindkeene.github.io/diner_dash/assets/explosion320x256.gif" class="w-full">`;
            document.getElementById('game-area').appendChild(ex);
            setTimeout(() => ex.remove(), 600);
        }

        function nextLevel() {
            level++; catchesThisLevel = 0; speedMultiplier += 0.2; isGamePaused = true;
            document.getElementById('status-message').innerHTML = `<p class="text-6xl font-brand text-yellow-400 animate-pulse">LEVEL ${level}</p>`;
            document.getElementById('difficulty-buttons').innerHTML = '';
            document.getElementById('overlay').classList.remove('hidden');
            setTimeout(() => { document.getElementById('overlay').classList.add('hidden'); isGamePaused = false; gameLoop(); }, 2000);
        }

        function endGame() {
            isGameOver = true; document.body.classList.remove('playing');
            saveScore();
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('status-message').innerHTML = `
                <p class="text-5xl font-brand text-red-500 mb-4">GAME OVER</p>
                <p class="text-3xl font-bold mb-8 uppercase tracking-widest">Score: ${score.toLocaleString()}</p>
            `;
            const btnContainer = document.getElementById('difficulty-buttons');
            btnContainer.innerHTML = ''; // Ensure container is clear for touch interaction
            const btn = document.createElement('button');
            btn.className = "bg-white text-black btn-4k hover:bg-slate-200";
            btn.textContent = "MAIN MENU";
            btn.onclick = (e) => {
                e.stopPropagation();
                showMenu();
            };
            btnContainer.appendChild(btn);
        }

        function updateStats() {
            document.getElementById('score-display').textContent = score.toString().padStart(6, '0');
            document.getElementById('lives-count').textContent = `×${lives}`;
            document.getElementById('level-display').textContent = `LVL ${level}`;
        }

        function handleInteraction(e) {
            if (isGameOver || isGamePaused) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const rect = document.getElementById('game-area').getBoundingClientRect();
            let rawX = ((clientX - rect.left) / rect.width) * 100;
            const lerp = gunkTimeRemaining > 0 ? 0.1 : 0.8;
            bucketX = bucketX + (rawX - bucketX) * lerp;
            bucketX = Math.max(4, Math.min(bucketX, 96));
            document.getElementById('buckets-stack').style.left = `${bucketX}%`;
        }

        function showMenu() {
            isGameOver = true; document.body.classList.remove('playing');
            document.getElementById('overlay').classList.remove('hidden');
            const btns = document.getElementById('difficulty-buttons'); 
            btns.innerHTML = '';
            document.getElementById('status-message').innerHTML = `
                <h1 class="text-7xl font-brand italic text-white mb-4">CATCH-22</h1>
                <p class="text-sm tracking-[0.6em] opacity-40 mb-12 uppercase font-black">4K Ultra Landscape Edition</p>
            `;
            Object.keys(THEMES).forEach(id => {
                const theme = THEMES[id];
                const high = leaderboards[id]?.score || 0;
                const b = document.createElement('button');
                b.className = `w-[400px] mb-4 btn-4k bg-slate-900/80 border-slate-700 hover:border-white text-left flex justify-between items-center`;
                b.innerHTML = `
                    <span class="font-brand" style="color: ${theme.color}">${theme.title}</span>
                    <span class="font-mono text-sm opacity-50">${high.toLocaleString()}</span>
                `;
                b.onclick = (e) => {
                    e.stopPropagation();
                    startGame(id);
                };
                btns.appendChild(b);
            });
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        window.toggleFullscreen = toggleFullscreen;

        window.onload = () => {
            showMenu();
            const area = document.getElementById('game-area');
            area.addEventListener('mousemove', handleInteraction);
            area.addEventListener('touchstart', (e) => { 
                // Only prevent default if we are actively playing to avoid blocking menu clicks
                if (!isGameOver && !isGamePaused) {
                    e.preventDefault(); 
                    handleInteraction(e); 
                }
            }, { passive: false });
            area.addEventListener('touchmove', (e) => { 
                if (!isGameOver && !isGamePaused) {
                    e.preventDefault(); 
                    handleInteraction(e); 
                }
            }, { passive: false });

            // Show fullscreen button only if supported
            if (!document.fullscreenEnabled) {
                document.getElementById('fullscreen-toggle').style.display = 'none';
            }
        };
    </script>
</head>
<body>
    <div id="game-container">
        <!-- 4K HUD -->
        <div class="w-full bg-slate-950 border-b-4 border-slate-900 p-6 z-20 flex justify-between items-center">
            <div class="flex flex-col">
                <span class="hud-sub text-slate-500 font-black uppercase tracking-widest">Global Ranking System</span>
                <span id="score-display" class="hud-text text-indigo-400 font-mono font-black leading-none">000000</span>
            </div>
            
            <div class="flex gap-12 items-center">
                <!-- Fullscreen Toggle -->
                <button id="fullscreen-toggle" onclick="toggleFullscreen()" class="hud-sub border-2 border-slate-700 text-slate-400 px-4 py-2 rounded-lg font-black uppercase tracking-tighter">
                    Fullscreen
                </button>

                <div class="flex flex-col items-center">
                    <span id="level-display" class="hud-sub font-black text-yellow-500 uppercase">Sector 01</span>
                    <div class="flex items-center gap-3 mt-1">
                        <img id="life-icon" src="" class="w-8 h-6 object-contain pixel-art">
                        <span id="lives-count" class="hud-text text-white font-black">×3</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME AREA -->
        <div id="game-area">
            <div id="gunk-overlay"></div>
            <div id="mad-bomber-img" class="mad-bomber-img"></div>
            <div id="buckets-stack" class="bucket-stack"></div>
            
            <div id="overlay" class="game-status-overlay">
                <div class="text-center w-full">
                    <div id="status-message"></div>
                    <div id="difficulty-buttons" class="flex flex-col items-center"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
