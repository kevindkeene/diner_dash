<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Boma's Burgers - Diner Dash</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&family=Bungee&display=swap');
        
        :root {
            /* 1 gu = 1% of container width. Maintains 16:9 scaling. */
            --gu: min(1vw, 1.77vh); 
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000; 
            color: #f9fafb; 
            margin: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden; 
            user-select: none;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: min(100vw, calc(100vh * (16 / 9)));
            height: min(100vh, calc(100vw * (9 / 16)));
            display: flex;
            flex-direction: column;
            background: #000;
            overflow: hidden;
        }

        #game-area {
            position: relative;
            width: 100%;
            flex-grow: 1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden;
            touch-action: none; 
        }

        /* --- UI OVERLAY SYSTEM --- */
        .game-status-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: flex-start; 
            z-index: 300;
            pointer-events: none;
        }

        .overlay-dark {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            justify-content: center !important; 
            pointer-events: auto;
        }

        .road-stack {
            margin-top: calc(var(--gu) * 33); 
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .reg-container {
            width: 85%;
            max-width: calc(var(--gu) * 60);
            display: flex;
            flex-direction: column;
            gap: calc(var(--gu) * 0.8);
        }

        .leaderboard-card {
            background: rgba(20, 20, 20, 0.8);
            padding: calc(var(--gu) * 1.5) calc(var(--gu) * 3);
            border-radius: calc(var(--gu) * 1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: calc(var(--gu) * 85);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: calc(var(--gu) * 1);
        }

        .lb-rank { font-size: calc(var(--gu) * 4); color: #ffbf47; font-family: 'Bungee', cursive; margin-right: calc(var(--gu) * 2.5); }
        .lb-name { font-size: calc(var(--gu) * 2.8); font-weight: 900; text-transform: uppercase; color: #fff; line-height: 1; }
        .lb-company { font-size: calc(var(--gu) * 1); font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.15em; margin-top: calc(var(--gu) * 0.2); }
        .lb-score { font-size: calc(var(--gu) * 5); font-weight: 900; color: #ffbf47; font-family: monospace; }

        .btn-pill {
            padding: calc(var(--gu) * 0.8) calc(var(--gu) * 6);
            border-radius: calc(var(--gu) * 4);
            font-weight: 900;
            text-transform: uppercase;
            transition: all 0.2s;
            cursor: pointer;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffbf47;
            color: #000;
            font-size: calc(var(--gu) * 1.8);
            border: none;
            margin-top: calc(var(--gu) * 2);
            box-shadow: 0 5px 20px rgba(255, 191, 71, 0.3);
        }
        .btn-pill:active { transform: scale(0.95); }
        .btn-pill:hover { filter: brightness(1.1); }

        .btn-secondary {
            background: transparent;
            color: #9ca3af;
            font-size: calc(var(--gu) * 1.2);
            font-weight: 700;
            text-transform: uppercase;
            margin-top: calc(var(--gu) * 1.5);
            cursor: pointer;
            text-decoration: underline;
            text-underline-offset: 4px;
            pointer-events: auto;
        }

        .expo-header {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            text-transform: uppercase;
            color: #ffbf47;
            letter-spacing: 0.4em;
            font-size: calc(var(--gu) * 1.8);
            text-align: center;
            margin-bottom: calc(var(--gu) * 2);
        }

        .countdown-text { font-size: calc(var(--gu) * 14); font-family: 'Bungee', cursive; color: #fff; text-shadow: 0 0 40px rgba(255,191,71,0.5); line-height: 1; }
        .go-title { font-size: calc(var(--gu) * 8); font-family: 'Bungee', cursive; color: #ef4444; font-style: italic; line-height: 1; text-align: center; }
        .go-score { font-size: calc(var(--gu) * 7); font-weight: 900; color: #ffbf47; font-family: monospace; margin-top: calc(var(--gu) * 0.5); }

        /* --- FORM STYLING --- */
        .reg-label { display: block; text-transform: uppercase; font-weight: 900; letter-spacing: 0.2em; color: #ffbf47; margin-bottom: calc(var(--gu) * 0.3); font-size: calc(var(--gu) * 1); }
        .form-input {
            background: rgba(255,255,255,0.08);
            border: calc(var(--gu) * 0.2) solid rgba(255,255,255,0.1);
            padding: calc(var(--gu) * 0.8) calc(var(--gu) * 1.5);
            border-radius: calc(var(--gu) * 1);
            color: white;
            font-size: calc(var(--gu) * 1.6);
            width: 100%;
            outline: none;
            margin-bottom: calc(var(--gu) * 1);
            transition: border-color 0.2s;
        }
        .form-input:focus { border-color: #ffbf47; }

        /* --- HUD --- */
        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: calc(var(--gu) * 1.5); z-index: 500; pointer-events: none; }
        .hud-text { font-size: calc(var(--gu) * 2.5); text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .hud-sub { font-size: calc(var(--gu) * 1); text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* --- ADMIN DASHBOARD --- */
        #admin-panel {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #0a0a0a;
            color: white;
            z-index: 2000;
            display: none;
            padding: calc(var(--gu) * 3);
            overflow-y: auto;
        }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: calc(var(--gu)*1.2); }
        .admin-table th, .admin-table td { text-align: left; padding: 12px; border-bottom: 1px solid #333; }
        .admin-table th { color: #ffbf47; text-transform: uppercase; font-weight: 900; }

        #gunk-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #a3e635; 
            pointer-events: none;
            z-index: 450; 
            opacity: 0;
            transition: opacity 0.1s;
        }

        .character-container { 
            position: absolute; 
            z-index: 100; 
            transform: translateX(-50%); 
            display: flex;
            justify-content: center;
            pointer-events: none;
        }
        .character-container img {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        #mad-bomber-img { 
            top: 0; 
            width: calc(var(--gu) * 12.135); 
            aspect-ratio: 466 / 415;
            align-items: flex-start;
        }

        #waitress-container { 
            bottom: 0; 
            z-index: 90;
            width: calc(var(--gu) * 19.7135); 
            aspect-ratio: 757 / 415;
            align-items: flex-end;
            will-change: left;
        }

        .bomb-img { position: absolute; z-index: 50; transform: translateX(-50%); }
        .explosion-img { position: absolute; z-index: 200; pointer-events: none; transform: translate(-50%, -50%); width: calc(var(--gu) * 15); }

        @keyframes riseAndFade {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, calc(var(--gu) * -10)); opacity: 0; }
        }
        .floating-points {
            position: absolute;
            font-family: 'Bungee', cursive;
            color: #ffbf47;
            font-weight: 900;
            pointer-events: none;
            z-index: 600;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            animation: riseAndFade 1s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        #toast {
            position: absolute;
            bottom: 5%; left: 50%;
            transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: calc(var(--gu) * 1) calc(var(--gu) * 2.5);
            border-radius: calc(var(--gu) * 0.5);
            font-size: calc(var(--gu) * 1.4);
            font-weight: bold;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .playing #game-area { cursor: none; }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDocs, addDoc, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const ASSETS_PATH = "https://kevindkeene.github.io/diner_dash/assets/";
        const THEME = {
            graphics: {
                BOMBER: ASSETS_PATH + '50s-chef.svg',
                OHNO_CHEF: ASSETS_PATH + '50s-chef-ohno.svg',
                WAITRESS: ASSETS_PATH + '50s-waitress.svg',
                OHNO_WAITRESS: ASSETS_PATH + '50s-waitress-ohno.svg',
                FOOD_ITEMS: [
                    { file: '50s-fries.svg', value: 10 },
                    { file: '50s-shake.svg', value: 25 },
                    { file: '50s-burger.svg', value: 50 }
                ],
                BUCKET: ASSETS_PATH + 'bucket.gif', 
                BACKGROUND: ASSETS_PATH + 'diner-inside.svg',
                SLIME: ASSETS_PATH + 'slimeball.gif',
                SPLASH: ASSETS_PATH + 'splash-screen.svg',
                EXPLOSION: ASSETS_PATH + 'explosion320x256.gif'
            }
        };

        // Firebase Setup
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'catch-22-v2';
        let db, auth, user = null, currentPlayer = null;

        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            initAuth();

            onAuthStateChanged(auth, (u) => {
                user = u;
                if (u) fetchLeaderboards();
            });
        }

        // Game State
        let score = 0, lives = 3, frame = 0, bombs = [];
        let bucketX = 50, targetX = 50, madBomberX = 50, madBomberDirection = 1;
        let totalItemsCaught = 0, difficultyFactor = 1, gunkTimeRemaining = 0, animationFrameHandle, allScores = [];
        let isGameOver = true, isCountdownActive = false, isMissSequence = false;
        let countdownTimer = 0, countdownValue = 5, adminClicks = 0;
        let lastInteractionTime = Date.now();
        const INACTIVITY_LIMIT = 20000; 

        // Character Meta
        const CHEF_WIDTH_GU = 12.135;
        const CHEF_TRAY_TOP_PCT = 76.6;     
        const WAITRESS_WIDTH_GU = 19.7135;
        let nextQueuedItem = null; 

        // Exponential backoff for Firebase writes
        const retryWrite = async (fn, maxRetries = 5) => {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try { return await fn(); }
                catch (e) {
                    if (i === maxRetries - i) throw e;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        };

        async function fetchLeaderboards() {
            if (!db || !user) return;
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
            onSnapshot(q, (snapshot) => {
                allScores = [];
                snapshot.forEach(doc => allScores.push(doc.data()));
                if (isGameOver) updateLeaderboardUI();
            }, (err) => console.error("Leaderboard fail", err));
        }

        function updateLeaderboardUI() {
            const container = document.getElementById('daily-leaderboard');
            if (!container) return;
            const topOne = [...allScores].sort((a, b) => b.score - a.score).slice(0, 1);
            if (topOne.length === 0) {
                container.innerHTML = `<p class="opacity-40 italic text-center" style="font-size: calc(var(--gu)*1.5)">Waiting for the first Dasher...</p>`;
                return;
            }
            container.innerHTML = topOne.map((s) => `
                <div class="leaderboard-card mx-auto">
                    <div class="flex items-center">
                        <span class="lb-rank">#1</span>
                        <div class="text-left">
                            <p class="lb-name">${s.name || 'Dash'}</p>
                            <p class="lb-company">${s.company || '---'}</p>
                        </div>
                    </div>
                    <div class="text-right"><p class="lb-score">${s.score.toLocaleString()}</p></div>
                </div>
            `).join('');
        }

        async function saveLead() {
            if (!db || !user || !currentPlayer) return;
            await retryWrite(() => addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), {
                ...currentPlayer,
                timestamp: Date.now(),
                userId: user.uid
            }));
        }

        async function updateScoreInCloud() {
            if (!db || !user || score === 0 || !currentPlayer) return;
            const scoreId = `${user.uid}_${Date.now()}`;
            await retryWrite(() => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'scores', scoreId), {
                userId: user.uid,
                name: currentPlayer.name,
                company: currentPlayer.company,
                score,
                timestamp: Date.now()
            }));
        }

        async function startGame() {
            if (!currentPlayer) { showRegistration(); return; }
            await saveLead(); 
            
            isGameOver = false; isCountdownActive = true; isMissSequence = false;
            countdownValue = 5; countdownTimer = performance.now();
            document.body.classList.add('playing');
            document.getElementById('hud').classList.remove('hidden');
            score = 0; lives = 3; frame = 0; totalItemsCaught = 0; difficultyFactor = 1;
            madBomberX = 50; bucketX = 50; targetX = 50; gunkTimeRemaining = 0;
            bombs.forEach(b => b.el.remove()); bombs = [];
            
            rollNextItem();
            initGameElements();
            updateStats();
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('hidden'); overlay.classList.remove('overlay-dark'); 
            document.getElementById('difficulty-buttons').innerHTML = ''; 
            cancelAnimationFrame(animationFrameHandle);
            gameLoop();
        }

        function rollNextItem() {
            const isSlime = Math.random() < 0.12;
            if (isSlime) {
                nextQueuedItem = { type: 'slime', imgSrc: THEME.graphics.SLIME, value: 0 };
            } else {
                const rand = Math.random();
                let food = rand < 0.2 ? THEME.graphics.FOOD_ITEMS[2] : (rand < 0.5 ? THEME.graphics.FOOD_ITEMS[1] : THEME.graphics.FOOD_ITEMS[0]);
                nextQueuedItem = { type: 'good', imgSrc: ASSETS_PATH + food.file, value: food.value };
            }
            const trayImg = document.getElementById('tray-food-ready');
            if (trayImg) trayImg.src = nextQueuedItem.imgSrc;
        }

        function showRegistration() {
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('hidden'); overlay.classList.add('overlay-dark');
            document.getElementById('hud').classList.add('hidden');
            
            document.getElementById('status-message').innerHTML = `
                <div class="reg-container">
                    <h2 id="reg-trigger" class="font-bold text-white italic leading-none text-center cursor-pointer" style="font-size: calc(var(--gu)*5); margin-bottom: calc(var(--gu)*0.5); font-family: 'Bungee'">PLAYER PROFILE</h2>
                    <p class="text-sm opacity-50 font-bold tracking-[0.3em] uppercase text-center" style="font-size: calc(var(--gu)*1.2); margin-bottom: calc(var(--gu)*1.5)">Register for the Leaderboard</p>
                    <div class="text-left">
                        <label class="reg-label">Full Name</label><input type="text" id="reg-name" class="form-input" placeholder="Enter name...">
                        <label class="reg-label">Company</label><input type="text" id="reg-company" class="form-input" placeholder="Enter company...">
                        <label class="reg-label">Work Email</label><input type="email" id="reg-email" class="form-input" placeholder="Enter email...">
                    </div>
                </div>
            `;
            
            document.getElementById('reg-trigger').onclick = () => {
                adminClicks++;
                if (adminClicks >= 5) { adminClicks = 0; openAdminPanel(); }
            };

            const btns = document.getElementById('difficulty-buttons'); btns.innerHTML = '';
            const startBtn = document.createElement('button');
            startBtn.className = "btn-pill w-[85%] max-w-xl mx-auto";
            startBtn.textContent = "Start Game";
            startBtn.onclick = (e) => {
                e.stopPropagation();
                const name = document.getElementById('reg-name').value.trim();
                const company = document.getElementById('reg-company').value.trim();
                const email = document.getElementById('reg-email').value.trim();
                if (!name || !company || !email) { showToast("Required fields empty!"); return; }
                currentPlayer = { name, company, email };
                startGame();
            };
            
            const backBtn = document.createElement('button');
            backBtn.className = "btn-secondary";
            backBtn.textContent = "Back to Menu";
            backBtn.onclick = (e) => { e.stopPropagation(); showInitialSplash(); };

            btns.appendChild(startBtn);
            btns.appendChild(backBtn);
        }

        function gameLoop() {
            if (isGameOver) return;
            frame++;
            difficultyFactor = 1 + (totalItemsCaught * 0.05);

            const lerp = gunkTimeRemaining > 0 ? 0.06 : 0.3; 
            bucketX = bucketX + (targetX - bucketX) * lerp; 
            
            const minX = -((347 / 757 - 0.5) * WAITRESS_WIDTH_GU);
            const maxX = 100 - (((347 + 390) / 757 - 0.5) * WAITRESS_WIDTH_GU);
            bucketX = Math.max(minX, Math.min(bucketX, maxX));
            document.getElementById('waitress-container').style.left = `${bucketX}%`;

            if (isMissSequence) {
                if (frame % 12 === 0 && bombs.length > 0) {
                    const b = bombs.pop();
                    createExplosion(b.x, b.y);
                    b.el.remove();
                    triggerHaptic(100);
                }
                if (bombs.length === 0 && frame % 100 === 0) {
                    isMissSequence = false;
                    if (lives <= 0) endGame();
                    else {
                        isCountdownActive = true; countdownValue = 3; countdownTimer = performance.now();
                        document.getElementById('overlay').classList.remove('hidden');
                    }
                }
            } else if (isCountdownActive) {
                const now = performance.now();
                if (now - countdownTimer > 1000) { countdownTimer = now; countdownValue--; triggerHaptic(50); }
                const status = document.getElementById('status-message');
                if (countdownValue > 0) status.innerHTML = `<div class="road-stack"><p class="countdown-text">${countdownValue}</p></div>`;
                else if (countdownValue === 0) status.innerHTML = `<div class="road-stack"><p class="countdown-text">GO!</p></div>`;
                else { isCountdownActive = false; document.getElementById('overlay').classList.add('hidden'); }
            } else {
                if (gunkTimeRemaining > 0) { 
                    gunkTimeRemaining -= 16; 
                    document.getElementById('gunk-overlay').style.opacity = (gunkTimeRemaining / 3000) * 0.7; 
                } else { document.getElementById('gunk-overlay').style.opacity = 0; }
                
                updateBomber(); 
                updateBombs();
                if (frame % 10 === 0) updateStats();
            }
            animationFrameHandle = requestAnimationFrame(gameLoop);
        }

        function updateBomber() {
            const base = (1.0) * difficultyFactor;
            if (Math.random() < 0.04) madBomberDirection *= -1;
            madBomberX += madBomberDirection * base;
            
            if (madBomberX > 94) madBomberDirection = -1; else if (madBomberX < 6) madBomberDirection = 1;
            document.getElementById('mad-bomber-img').style.left = `${madBomberX}%`;
            
            const dropRate = Math.max(15, 80 / Math.sqrt(difficultyFactor));
            if (frame % Math.floor(dropRate) === 0) {
                const offset = (CHEF_WIDTH_GU * -0.2908);
                const spawnX = madBomberX + offset;
                const spawnY = 15; 
                createFallingBomb(spawnX, spawnY, nextQueuedItem);
                rollNextItem();
            }
        }

        function createFallingBomb(x, y, data) {
            const el = document.createElement('div');
            el.className = 'bomb-img absolute';
            el.style.width = `calc(var(--gu)*5)`; el.style.left = `${x}%`; el.style.top = `${y}%`;
            el.innerHTML = `<img src="${data.imgSrc}" style="width: 100%; height: 100%; object-fit: contain;">`;
            document.getElementById('game-area').appendChild(el);
            
            bombs.push({ 
                x, y, el, type: data.type, 
                value: data.value, 
                speed: (1.2) * Math.sqrt(difficultyFactor) 
            });
        }

        function updateBombs() {
            for (let i = bombs.length - 1; i >= 0; i--) {
                const b = bombs[i]; 
                b.y += b.speed; 
                b.el.style.top = `${b.y}%`;
                
                const trayTop = 75; 
                const waitressLeft = bucketX - (WAITRESS_WIDTH_GU / 2);
                const trayLeft = waitressLeft + (WAITRESS_WIDTH_GU * (347 / 757));
                const trayRight = trayLeft + (WAITRESS_WIDTH_GU * (390 / 757));

                if (b.y >= trayTop && b.y < trayTop + 5) {
                    if (b.x > trayLeft && b.x < trayRight) {
                        handleCatch(i, b, trayTop);
                        continue;
                    }
                }

                if (b.y > 98) {
                    if (b.type === 'good') handleMiss(i, b);
                    else { b.el.remove(); bombs.splice(i, 1); }
                }
            }
        }

        function handleCatch(idx, b, trayY) {
            if (b.type === 'slime') { gunkTimeRemaining = 3000; triggerHaptic(100); } 
            else {
                const multiplier = Math.floor(difficultyFactor);
                const points = b.value * multiplier; 
                score += points; 
                totalItemsCaught++;
                triggerHaptic(20);
                showFloatingPoints(b.x, trayY, `+${points}`);
            }
            b.el.remove(); bombs.splice(idx, 1); updateStats();
        }

        function handleMiss(idx, b) {
            if (isMissSequence) return;
            isMissSequence = true; triggerHaptic(300); lives--;
            updateStats();
            createExplosion(b.x, 90);
            b.el.remove(); bombs.splice(idx, 1);

            const waitressImg = document.querySelector('#waitress-container img');
            if (waitressImg) waitressImg.src = THEME.graphics.OHNO_WAITRESS;

            setTimeout(() => {
                if (waitressImg) waitressImg.src = THEME.graphics.WAITRESS;
            }, 1500);
        }

        function endGame() {
            isGameOver = true; isCountdownActive = false; isMissSequence = false;
            cancelAnimationFrame(animationFrameHandle);
            document.body.classList.remove('playing'); 
            updateScoreInCloud();
            
            const area = document.getElementById('game-area'); 
            area.style.backgroundImage = `url('${THEME.graphics.SPLASH}')`;
            document.getElementById('mad-bomber-img').innerHTML = '';
            document.getElementById('waitress-container').innerHTML = '';
            document.getElementById('hud').classList.add('hidden'); 
            
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('hidden'); overlay.classList.remove('overlay-dark'); 
            document.getElementById('status-message').innerHTML = `
                <div class="road-stack">
                    <p class="go-title">GAME OVER</p>
                    <p class="go-score">${score.toLocaleString()}</p>
                    <p class="go-sub" style="font-size: calc(var(--gu)*1.2); opacity: 0.5; margin-top: 10px; font-weight: bold; letter-spacing: 0.3em; text-transform: uppercase">FINAL SCORE RECORDED</p>
                </div>
            `;
            const btns = document.getElementById('difficulty-buttons'); btns.innerHTML = '';
            const btn = document.createElement('button'); btn.className = "btn-pill"; btn.textContent = "MAIN MENU"; 
            btn.onclick = (e) => { e.stopPropagation(); showInitialSplash(); }; 
            btns.appendChild(btn);
        }

        function updateStats() { 
            const scoreDisplay = document.getElementById('score-display');
            if (scoreDisplay) scoreDisplay.textContent = score.toString().padStart(6, '0'); 
            const livesDisplay = document.getElementById('lives-count');
            if (livesDisplay) livesDisplay.textContent = `×${lives}`; 
            const levelDisplay = document.getElementById('level-display');
            if (levelDisplay) levelDisplay.textContent = `×${Math.floor(difficultyFactor)} DASH BOOST`; 
        }

        function showFloatingPoints(x, y, text) {
            const el = document.createElement('div'); 
            el.className = 'floating-points';
            el.style.left = `${x}%`; 
            el.style.top = `${y}%`; 
            el.style.fontSize = `calc(var(--gu)*3)`; 
            el.textContent = text;
            document.getElementById('game-area').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function openAdminPanel() {
            const panel = document.getElementById('admin-panel');
            panel.style.display = 'block';
            const tbody = document.getElementById('admin-tbody');
            tbody.innerHTML = '<tr><td colspan="3">Fetching leads...</td></tr>';
            (async () => {
                try {
                    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'leads'));
                    let html = '';
                    let leads = [];
                    snap.forEach(doc => {
                        const data = doc.data();
                        leads.push(data);
                        html += `<tr><td>${data.name}</td><td>${data.company}</td><td>${data.email}</td></tr>`;
                    });
                    tbody.innerHTML = html || '<tr><td colspan="3">No leads captured yet.</td></tr>';
                    window.currentLeads = leads;
                } catch (e) { tbody.innerHTML = '<tr><td colspan="3">Error loading data.</td></tr>'; }
            })();
        }

        function downloadLeadsCSV() {
            if (!window.currentLeads || window.currentLeads.length === 0) return;
            const headers = ['Name', 'Company', 'Email', 'Timestamp'];
            const rows = window.currentLeads.map(l => [`"${l.name}"`, `"${l.company}"`, `"${l.email}"`, new Date(l.timestamp).toLocaleString()].join(','));
            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `expo_leads_${Date.now()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showInitialSplash() {
            isGameOver = true; isCountdownActive = false; isMissSequence = false;
            document.body.classList.remove('playing'); document.getElementById('hud').classList.add('hidden');
            document.getElementById('mad-bomber-img').innerHTML = ''; document.getElementById('waitress-container').innerHTML = '';
            bombs.forEach(b => b.el.remove()); bombs = [];
            const overlay = document.getElementById('overlay'); 
            overlay.classList.remove('hidden'); overlay.classList.remove('overlay-dark'); 
            const area = document.getElementById('game-area'); 
            area.style.backgroundImage = `url('${THEME.graphics.SPLASH}')`;
            document.getElementById('status-message').innerHTML = `
                <div class="road-stack">
                    <p class="expo-header">THE EXPO'S TOP DASHER</p>
                    <div id="daily-leaderboard" class="w-full flex justify-center"></div>
                </div>
            `;
            updateLeaderboardUI();
            const btns = document.getElementById('difficulty-buttons'); btns.innerHTML = '';
            const btn = document.createElement('button'); 
            btn.className = "btn-pill shadow-xl"; btn.textContent = "Start Game";
            btn.onclick = (e) => { e.stopPropagation(); currentPlayer = null; showRegistration(); };
            btns.appendChild(btn);
        }

        function initGameElements() {
            const area = document.getElementById('game-area');
            area.style.backgroundImage = `url('${THEME.graphics.BACKGROUND}')`;
            
            document.getElementById('mad-bomber-img').innerHTML = `
                <img src="${THEME.graphics.BOMBER}" style="width: 100%; height: 100%;">
                <div id="tray-food-container" style="
                    position: absolute;
                    top: ${CHEF_TRAY_TOP_PCT}%;
                    left: 20.92%; 
                    width: 41.2%; 
                    aspect-ratio: 1/1;
                    transform: translate(-50%, -100%);
                    z-index: 101;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <img id="tray-food-ready" src="${nextQueuedItem ? nextQueuedItem.imgSrc : ''}" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
            `;

            document.getElementById('waitress-container').innerHTML = `<img src="${THEME.graphics.WAITRESS}" style="width: 100%; height: 100%;">`;
            document.getElementById('life-icon').src = THEME.graphics.BUCKET;
        }

        function createExplosion(x, y) {
            const ex = document.createElement('div');
            ex.className = 'explosion-img';
            ex.style.left = `${x}%`; ex.style.top = `${y}%`;
            ex.innerHTML = `<img src="${THEME.graphics.EXPLOSION}" class="w-full">`;
            document.getElementById('game-area').appendChild(ex);
            setTimeout(() => ex.remove(), 800);
        }

        function handleInteraction(e) {
            lastInteractionTime = Date.now();
            if (isGameOver) return; 
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const rect = document.getElementById('game-area').getBoundingClientRect();
            targetX = ((clientX - rect.left) / rect.width) * 100;
        }

        function showToast(msg) { const toast = document.getElementById('toast'); toast.textContent = msg; toast.style.opacity = '1'; setTimeout(() => { toast.style.opacity = '0'; }, 3000); }
        function triggerHaptic(ms) { if ("vibrate" in navigator) navigator.vibrate(ms); }

        window.closeAdmin = () => document.getElementById('admin-panel').style.display = 'none';
        window.downloadLeadsCSV = downloadLeadsCSV;
        
        window.onload = () => {
            showInitialSplash();
            const area = document.getElementById('game-area');
            area.addEventListener('mousemove', handleInteraction);
            area.addEventListener('touchstart', (e) => { if (!isGameOver) { e.preventDefault(); handleInteraction(e); } }, { passive: false });
            area.addEventListener('touchmove', (e) => { if (!isGameOver) { e.preventDefault(); handleInteraction(e); } }, { passive: false });
            
            setInterval(() => {
                if (isGameOver && !document.body.classList.contains('playing')) {
                    if (Date.now() - lastInteractionTime > INACTIVITY_LIMIT) {
                        const statusMsg = document.getElementById('status-message');
                        if (!statusMsg.querySelector('.expo-header')) showInitialSplash();
                    }
                }
            }, 1000);
        };
    </script>
</head>
<body>
    <div id="game-container">
        <div id="admin-panel">
            <div class="flex justify-between items-center border-b border-gray-700 pb-4">
                <h1 class="text-2xl font-black text-yellow-500">EXPO LEADS</h1>
                <div class="flex gap-4">
                    <button onclick="downloadLeadsCSV()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-bold uppercase text-xs transition-colors">Export CSV</button>
                    <button onclick="closeAdmin()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-bold uppercase text-xs transition-colors">Close</button>
                </div>
            </div>
            <table class="admin-table">
                <thead><tr><th>Name</th><th>Company</th><th>Email</th></tr></thead>
                <tbody id="admin-tbody"></tbody>
            </table>
        </div>

        <div id="toast">Required fields empty!</div>
        
        <div id="game-area">
            <div id="hud" class="flex justify-between items-start hidden">
                <div class="flex flex-col text-left">
                    <span class="hud-sub text-white/50 font-black uppercase tracking-widest">Global Ranking System</span>
                    <span id="score-display" class="hud-text font-mono font-black leading-none" style="color: #ffbf47">000000</span>
                </div>
                <div class="flex gap-8 items-start">
                    <div class="flex flex-col items-end">
                        <span id="level-display" class="hud-sub font-black text-yellow-500 uppercase">×1 DASH BOOST</span>
                        <div class="flex items-center gap-2 mt-1">
                            <img id="life-icon" src="" class="w-[calc(var(--gu)*4)] h-auto">
                            <span id="lives-count" class="hud-text text-white font-black">×3</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gunk-overlay"></div>
            <div id="mad-bomber-img" class="character-container"></div>
            <div id="waitress-container" class="character-container"></div>
            
            <div id="overlay" class="game-status-overlay">
                <div id="status-message" class="w-full flex flex-col items-center"></div>
                <div id="difficulty-buttons" class="w-full flex flex-col items-center justify-center"></div>
            </div>
        </div>
    </div>
</body>
</html>
